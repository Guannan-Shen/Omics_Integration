---
title: "Gene Lists and LPS"
author: "Guannan Shen"
date: "June 11, 2019"
output: 
  html_document:
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 5
    toc_float: no
  word_document:
    toc: yes
    toc_depth: '5'
  pdf_document:
    latex_engine: lualatex
    number_sections: yes
    toc: yes
    toc_depth: 5
---

```{r setup, include=FALSE, cache = FALSE}
require("knitr")
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
opts_chunk$set(engine = "R")
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
## setting wd in DELL
## opts_knit$set(root.dir = "~/Stats/CIDA_OMICs/CIDA_OMICS/7659Stats_Genetics/HW5/")
## setting working directory in asus 
## opts_knit$set(root.dir = "C:/Users/hithr/Documents/Stats/gitlab/Cario_RNASeq_Microbiom_Inte/DataRaw/") 
## setting working directory in ubuntu
opts_knit$set(root.dir = "~/Documents/gitlab/Omics_Integration/DataRaw/hiv_infected_un/")
                                                 
## cache = F, if cache = T, will not revaluate code chunk everytime
## double or more space to insert a line break
```


```{r libs, echo = FALSE, warning= F}
######################
## Set up workspace
######################
rm(list = ls())
library(openxlsx)
library(tidyverse)
library(magrittr)
library(BiocStyle)
library(caret)   # for cross validation

library(SmCCNet)

options(stringsAsFactors = F)
options(dplyr.width = Inf)
getwd()

# directory, Ubuntu 
dir = "~/Documents/gitlab/Omics_Integration/"
# small functions, %nin%, %||%, isnothing
source( paste0(dir, "Code/small_fun.R") )

# ######## clean memory ######################
# rm(list = ls())
# gc()
# is(dds)
# slotNames(dds)
```

# Data and Functions

```{r importdata}
# source functions 
# source to get the load_filtered_micro_level function to get clr of RA
source( paste0(dir, "Code/5_29_Generate_filtered_Data_Microbiome.R") )
# clean and transform transcriptome data, subset of genes
source( paste0(dir, "Code/6_5_clean_transcriptome.R") )
# clinical data 
source( paste0(dir, "Code/6_5_clean_clinical.R") )
# diagnostic plots and tables
source( paste0(dir, "Code/ref_plots.R") )

########## Datasets #############
#### phenotype contains ID
clin <- rescaled_cli() 
# import gene lists #
isgs <- as.data.frame(read.delim( paste0(dir, "DataRaw/hiv_infected_un/coreISG")) )
genesbeta <- as.data.frame(read.delim( paste0(dir, "DataRaw/hiv_infected_un/genesbeta" )) )
# LPS
# Num 16 subjest is missing 
which(is.na( clin$LPS ))

#### Transcriptome
# get gene symbols 
rna_isgs <- rescaled_rna(isgs, rlog = T)
isgs_symbol = rna_isgs[[2]] %>% dplyr::select(Symbol)
# rlog transform or not
isgs_rlog <- rna_isgs[[1]]

#### Microbiome
gen_30_10 <- load_filtered_micro_level("genus",  prevalence = 30, RA = 10, wd = "Ubuntu")
micro_clr <- gen_30_10[[2]] %>% as.data.frame()
# rescale to mean 0 and variance 1 
mibi <- rescale_microbiome(micro_clr)
#
anyNA(mibi)
anyNA(isgs_rlog)


```

# Density Plots: Hints for weighted SmCCNet
For LPS, the measurement of subject 16 is missing.  
Skewness:  
> Although SmCCNet does not require normality, it calculates the Pearson correlation between
linear combinations of omics features and the phenotype, which assumes finite variances and
finite covariance. It is necessary to include a transformation if the data are skewed.

```{r ref_weights}
n_na = which(is.na( clin$LPS ))
# get hints ideas
# the final clinical parameter to use
clin_para = clin %>% select(LPS) %>% na.omit()
df1 = get_corr(mibi[-n_na, ], isgs_rlog[-n_na, ], "Microbiome:Core ISGs")
# stats::cor(clin$LPS, mibi, use = "pairwise.complete.obs", method = "pearson")
df2 = get_corr(clin_para, mibi[-n_na, ], "LPS:Microbiome")
df3 = get_corr(clin_para, isgs_rlog[-n_na, ], "LPS:Core ISGs")
# plots
data = rbind(df1, df2, df3)

box_values_group(data, "Pearson Correlations")
density_values_group(data, "Pearson Correlations")

# starting points of weights
print("From the boxplot and the Density Plot: Weights 10, 5, 1 for X1X2, LPS:Microbiome, LPS:Core ISGs")

# check skewness
check_skew(micro_clr, "Density Plot of CLR of Microbiome RA")
check_skew(rescaled_rna(isgs, rlog = F)[[3]], "Density Plot of without rlog Transcriptome")
check_skew(rna_isgs[[3]], "Density Plot of rlog Transcriptome")

```

# SmCCNet Parameters Engineering

```{r smccnet}
########## parameters ################
# by convention, the first Omics is transcriptome and the 2nd is the microbiome 
# this sample size, 25, the paper use 4-fold 
# missing
n_na = which(is.na( clin$LPS ))
# check ID order again
sum(rownames(mibi) != rownames(isgs_rlog) )
sum(rownames(isgs_rlog) != clin$ID)
# names
colnames(isgs_rlog) <- isgs_symbol$Symbol

# unchanged parameters
p1 <- ncol(isgs_rlog)
p2 <- ncol(mibi)
n <- nrow(isgs_rlog[-n_na, ])
AbarLabel <- c(colnames(cbind(isgs_rlog, mibi)))

# parameters 
K <- 4 # Number of folds in K-fold CV.
CCcoef <- NULL # Unweighted version of SmCCNet.
# Microbiome is the 2nd one, thus s2 is larger
s1 <- 0.7; s2 <- 0.9 # Feature sampling proportions.
SubsamplingNum <- 1000 # Number of subsamples.

```
